import { useState } from "react";

const categories = [
  {
    id: "percent",
    icon: "%",
    label: "××—×•×–×™×",
    color: "#FF6B35",
    tools: [
      {
        id: "discount",
        label: "×—×™×©×•×‘ ×”× ×—×”",
        fields: [
          { id: "price", label: "××—×™×¨ ××§×•×¨×™ (â‚ª)", type: "number" },
          { id: "discount", label: "××—×•×– ×”× ×—×” (%)", type: "number" },
        ],
        calculate: (f) => {
          const saved = (f.price * f.discount) / 100;
          const final = f.price - saved;
          return "××—×™×¨ ×¡×•×¤×™: â‚ª" + final.toFixed(2) + "\n×—×¡×›×ª: â‚ª" + saved.toFixed(2);
        },
      },
      {
        id: "vat_add",
        label: "×”×•×¡×¤×ª ××¢\"× (18%) â€” ×¡×›×•× ×œ×¤× ×™ ××¢\"×",
        fields: [
          { id: "price", label: "×¡×›×•× ×œ×¤× ×™ ××¢\"× (â‚ª)", type: "number" },
        ],
        calculate: (f) => {
          const vat = f.price * 0.18;
          const total = f.price + vat;
          return "××¢\"× (18%): â‚ª" + vat.toFixed(2) + "\n×¡×”\"×› ×›×•×œ×œ ××¢\"×: â‚ª" + total.toFixed(2);
        },
      },
      {
        id: "vat_remove",
        label: "×”×•×¦××ª ××¢\"× (18%) â€” ×¡×›×•× ×›×•×œ×œ ××¢\"×",
        fields: [
          { id: "total", label: "×¡×›×•× ×›×•×œ×œ ××¢\"× (â‚ª)", type: "number" },
        ],
        calculate: (f) => {
          const before = f.total / 1.18;
          const vat = f.total - before;
          return "×¡×›×•× ×œ×¤× ×™ ××¢\"×: â‚ª" + before.toFixed(2) + "\n××¢\"× ×‘×ª×•×š ×”×¡×›×•×: â‚ª" + vat.toFixed(2);
        },
      },
      {
        id: "price_before_rise",
        label: "××—×™×¨ ×œ×¤× ×™ ×¢×œ×™×™×” ×‘××—×•×–×™×",
        fields: [
          { id: "current", label: "×”××—×™×¨ ×”× ×•×›×—×™ (â‚ª)", type: "number" },
          { id: "rise", label: "××—×•×– ×”×¢×œ×™×™×” (%)", type: "number" },
        ],
        calculate: (f) => {
          const before = f.current / (1 + f.rise / 100);
          const diff = f.current - before;
          return "××—×™×¨ ×œ×¤× ×™ ×”×¢×œ×™×™×”: â‚ª" + before.toFixed(2) + "\n×›××” ×¢×œ×”: â‚ª" + diff.toFixed(2);
        },
      },
      {
        id: "tip",
        label: "×—×™×©×•×‘ ×˜×™×¤",
        fields: [
          { id: "bill", label: "×¡×›×•× ×”×—×©×‘×•×Ÿ (â‚ª)", type: "number" },
          { id: "tip", label: "××—×•×– ×˜×™×¤ (%)", type: "number" },
        ],
        calculate: (f) => {
          const tip = (f.bill * f.tip) / 100;
          const total = f.bill + tip;
          return "×˜×™×¤: â‚ª" + tip.toFixed(2) + "\n×¡×”\"×›: â‚ª" + total.toFixed(2);
        },
      },
      {
        id: "percent_of",
        label: "×›××” ××—×•×– X ××ª×•×š Y",
        fields: [
          { id: "part", label: "×”×—×œ×§ (X)", type: "number" },
          { id: "total", label: "×”×¡×›×•× ×”×›×•×œ×œ (Y)", type: "number" },
        ],
        calculate: (f) => {
          const pct = (f.part / f.total) * 100;
          return pct.toFixed(2) + "%";
        },
      },
    ],
  },
  {
    id: "money",
    icon: "â‚ª",
    label: "×›×¡×£",
    color: "#2EC4B6",
    tools: [
      {
        id: "mortgage",
        label: "×ª×©×œ×•× ××©×›× ×ª× ×—×•×“×©×™",
        fields: [
          { id: "loan", label: "×¡×›×•× ×”×”×œ×•×•××” (â‚ª)", type: "number" },
          { id: "rate", label: "×¨×™×‘×™×ª ×©× ×ª×™×ª (%)", type: "number" },
          { id: "years", label: "××¡×¤×¨ ×©× ×™×", type: "number" },
        ],
        calculate: (f) => {
          const r = f.rate / 100 / 12;
          const n = f.years * 12;
          const monthly = (f.loan * r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
          const total = monthly * n;
          return "×ª×©×œ×•× ×—×•×“×©×™: â‚ª" + monthly.toFixed(2) + "\n×¡×”\"×› ×ª×©×œ×•××™×: â‚ª" + total.toFixed(0) + "\n×¨×™×‘×™×ª ×›×•×œ×œ×ª: â‚ª" + (total - f.loan).toFixed(0);
        },
      },
      {
        id: "savings",
        label: "×—×™×¡×›×•×Ÿ ×¢× ×¨×™×‘×™×ª ×“×¨×™×‘×™×ª",
        fields: [
          { id: "amount", label: "×¡×›×•× ×”×ª×—×œ×ª×™ (â‚ª)", type: "number" },
          { id: "monthly", label: "×”×¤×§×“×” ×—×•×“×©×™×ª (â‚ª)", type: "number" },
          { id: "rate", label: "×¨×™×‘×™×ª ×©× ×ª×™×ª (%)", type: "number" },
          { id: "years", label: "××¡×¤×¨ ×©× ×™×", type: "number" },
        ],
        calculate: (f) => {
          const r = f.rate / 100 / 12;
          const n = f.years * 12;
          const future = f.amount * Math.pow(1 + r, n) + f.monthly * ((Math.pow(1 + r, n) - 1) / r);
          const invested = f.amount + f.monthly * n;
          return "×¡×”\"×› ×‘×—×™×¡×›×•×Ÿ: â‚ª" + future.toFixed(0) + "\n×”×¤×§×“×ª: â‚ª" + invested.toFixed(0) + "\n×¨×•×•×— ××¨×™×‘×™×ª: â‚ª" + (future - invested).toFixed(0);
        },
      },
      {
        id: "split",
        label: "×—×œ×•×§×ª ×—×©×‘×•×Ÿ",
        fields: [
          { id: "bill", label: "×¡×›×•× ×”×—×©×‘×•×Ÿ (â‚ª)", type: "number" },
          { id: "people", label: "××¡×¤×¨ ×× ×©×™×", type: "number" },
        ],
        calculate: (f) => {
          const per = f.bill / f.people;
          return "×›×œ ××—×“ ××©×œ×: â‚ª" + per.toFixed(2);
        },
      },
    ],
  },
  {
    id: "health",
    icon: "â¤ï¸",
    label: "×‘×¨×™××•×ª",
    color: "#E63946",
    tools: [
      {
        id: "bmi",
        label: "×—×™×©×•×‘ BMI",
        fields: [
          { id: "weight", label: "××©×§×œ (×§\"×’)", type: "number" },
          { id: "height", label: "×’×•×‘×” ×‘××˜×¨×™× (×œ×“×•×’××” 1.75)", type: "number" },
        ],
        calculate: (f) => {
          const bmi = f.weight / (f.height * f.height);
          let status = "";
          if (bmi < 18.5) status = "×ª×ª ××©×§×œ";
          else if (bmi < 25) status = "××©×§×œ ×ª×§×™×Ÿ";
          else if (bmi < 30) status = "×¢×•×“×£ ××©×§×œ";
          else status = "×”×©×× ×”";
          return "BMI: " + bmi.toFixed(1) + "\n×¡×˜×˜×•×¡: " + status;
        },
      },
      {
        id: "calories",
        label: "×¦×¨×™×›×ª ×§×œ×•×¨×™×•×ª ×™×•××™×ª",
        fields: [
          { id: "weight", label: "××©×§×œ (×§\"×’)", type: "number" },
          { id: "height", label: "×’×•×‘×” (×¡\"×)", type: "number" },
          { id: "age", label: "×’×™×œ", type: "number" },
          { id: "gender", label: "××™×Ÿ (1=×–×›×¨  2=× ×§×‘×”)", type: "number" },
        ],
        calculate: (f) => {
          let bmr;
          if (f.gender === 1) bmr = 10 * f.weight + 6.25 * f.height - 5 * f.age + 5;
          else bmr = 10 * f.weight + 6.25 * f.height - 5 * f.age - 161;
          return "×§×œ×•×¨×™×•×ª ×‘×¡×™×¡×™×•×ª: " + bmr.toFixed(0) + " ×§×§\"×œ\n×¤×¢×™×œ×•×ª ×§×œ×”: " + (bmr * 1.375).toFixed(0) + " ×§×§\"×œ\n×¤×¢×™×œ×•×ª ×‘×™× ×•× ×™×ª: " + (bmr * 1.55).toFixed(0) + " ×§×§\"×œ";
        },
      },
      {
        id: "ideal_weight",
        label: "××©×§×œ ××™×“×™××œ×™",
        fields: [
          { id: "height", label: "×’×•×‘×” (×¡\"×)", type: "number" },
        ],
        calculate: (f) => {
          const min = (f.height / 100) * (f.height / 100) * 18.5;
          const max = (f.height / 100) * (f.height / 100) * 24.9;
          return "×˜×•×•×— ××©×§×œ ×ª×§×™×Ÿ: " + min.toFixed(1) + " ×¢×“ " + max.toFixed(1) + " ×§\"×’";
        },
      },
    ],
  },
  {
    id: "car",
    icon: "ğŸš—",
    label: "×¨×›×‘",
    color: "#F4A261",
    tools: [
      {
        id: "fuel_cost",
        label: "×¢×œ×•×ª × ×¡×™×¢×” ×‘×‘× ×–×™×Ÿ",
        fields: [
          { id: "km", label: "××¨×—×§ (×§\"×)", type: "number" },
          { id: "consumption", label: "×¦×¨×™×›×ª ×“×œ×§ (×œ/100×§\"×)", type: "number" },
          { id: "price", label: "××—×™×¨ ×‘× ×–×™×Ÿ (â‚ª ×œ×œ×™×˜×¨)", type: "number" },
        ],
        calculate: (f) => {
          const liters = (f.km * f.consumption) / 100;
          const cost = liters * f.price;
          return "×œ×™×˜×¨×™× ×©×ª×¦×¨×•×š: " + liters.toFixed(2) + "\n×¢×œ×•×ª ×”× ×¡×™×¢×”: â‚ª" + cost.toFixed(2);
        },
      },
      {
        id: "travel_time",
        label: "×–××Ÿ × ×¡×™×¢×” ××©×•×¢×¨",
        fields: [
          { id: "km", label: "××¨×—×§ (×§\"×)", type: "number" },
          { id: "speed", label: "××”×™×¨×•×ª ×××•×¦×¢×ª (×§×\"×©)", type: "number" },
        ],
        calculate: (f) => {
          const hours = f.km / f.speed;
          const h = Math.floor(hours);
          const m = Math.round((hours - h) * 60);
          return "×–××Ÿ × ×¡×™×¢×”: " + (h > 0 ? h + " ×©×¢×•×ª ×•-" : "") + m + " ×“×§×•×ª";
        },
      },
      {
        id: "monthly_fuel",
        label: "×”×•×¦××” ×—×•×“×©×™×ª ×¢×œ ×“×œ×§",
        fields: [
          { id: "daily_km", label: "×§\"× ×‘×™×•× ×‘×××•×¦×¢", type: "number" },
          { id: "consumption", label: "×¦×¨×™×›×ª ×“×œ×§ (×œ/100×§\"×)", type: "number" },
          { id: "price", label: "××—×™×¨ ×‘× ×–×™×Ÿ (â‚ª ×œ×œ×™×˜×¨)", type: "number" },
        ],
        calculate: (f) => {
          const monthly_km = f.daily_km * 30;
          const liters = (monthly_km * f.consumption) / 100;
          const cost = liters * f.price;
          return "×§\"× ×‘×—×•×“×©: " + monthly_km + "\n×œ×™×˜×¨×™×: " + liters.toFixed(1) + "\n×¢×œ×•×ª ×—×•×“×©×™×ª: â‚ª" + cost.toFixed(0);
        },
      },
    ],
  },
  {
    id: "kitchen",
    icon: "ğŸ³",
    label: "××˜×‘×—",
    color: "#8AC926",
    tools: [
      {
        id: "convert_cups",
        label: "×›×•×¡×•×ª ×œ×\"×œ",
        fields: [
          { id: "cups", label: "×›××•×ª ×‘×›×•×¡×•×ª", type: "number" },
        ],
        calculate: (f) => f.cups + " ×›×•×¡×•×ª = " + (f.cups * 240).toFixed(0) + " ×\"×œ",
      },
      {
        id: "recipe_scale",
        label: "×©×™× ×•×™ ×›××•×ª ×‘××ª×›×•×Ÿ",
        fields: [
          { id: "original", label: "×× ×•×ª ×‘××§×•×¨", type: "number" },
          { id: "desired", label: "×× ×•×ª ×¨×¦×•×™×•×ª", type: "number" },
          { id: "ingredient", label: "×›××•×ª ××¨×›×™×‘", type: "number" },
        ],
        calculate: (f) => {
          const ratio = f.desired / f.original;
          const newAmount = f.ingredient * ratio;
          return "×¤×§×˜×•×¨ ×©×™× ×•×™: x" + ratio.toFixed(2) + "\n×›××•×ª ×—×“×©×”: " + newAmount.toFixed(2);
        },
      },
      {
        id: "temp_convert",
        label: "×”××¨×ª ×˜××¤×¨×˜×•×¨×”",
        fields: [
          { id: "celsius", label: "××¢×œ×•×ª ×¦×œ×–×™×•×¡", type: "number" },
        ],
        calculate: (f) => {
          const fahr = (f.celsius * 9) / 5 + 32;
          return f.celsius + " ××¢×œ×•×ª ×¦×œ×–×™×•×¡ = " + fahr.toFixed(1) + " ×¤×¨× ×”×™×™×˜";
        },
      },
    ],
  },
  {
    id: "math",
    icon: "ğŸ“",
    label: "××ª××˜×™×§×”",
    color: "#A855F7",
    tools: [
      {
        id: "quadratic",
        label: "×¤×ª×¨×•×Ÿ ××©×•×•××” ×¨×™×‘×•×¢×™×ª",
        fields: [
          { id: "a", label: "××§×“× a", type: "number" },
          { id: "b", label: "××§×“× b", type: "number" },
          { id: "c", label: "××§×“× c", type: "number" },
        ],
        calculate: (f) => {
          const disc = f.b * f.b - 4 * f.a * f.c;
          if (disc < 0) return "××™×Ÿ ×¤×ª×¨×•×Ÿ ×××©×™";
          const x1 = (-f.b + Math.sqrt(disc)) / (2 * f.a);
          const x2 = (-f.b - Math.sqrt(disc)) / (2 * f.a);
          if (disc === 0) return "×¤×ª×¨×•×Ÿ ×™×—×™×“: x = " + x1.toFixed(4);
          return "x1 = " + x1.toFixed(4) + "\nx2 = " + x2.toFixed(4);
        },
      },
      {
        id: "fraction",
        label: "×—×™×‘×•×¨ ×©×‘×¨×™×",
        fields: [
          { id: "n1", label: "××•× ×” ×©×‘×¨ 1", type: "number" },
          { id: "d1", label: "××›× ×” ×©×‘×¨ 1", type: "number" },
          { id: "n2", label: "××•× ×” ×©×‘×¨ 2", type: "number" },
          { id: "d2", label: "××›× ×” ×©×‘×¨ 2", type: "number" },
        ],
        calculate: (f) => {
          const n = f.n1 * f.d2 + f.n2 * f.d1;
          const d = f.d1 * f.d2;
          const gcd = (a, b) => (b === 0 ? a : gcd(b, a % b));
          const g = gcd(Math.abs(n), Math.abs(d));
          return "×”×ª×•×¦××”: " + (n / g) + "/" + (d / g) + "\n×‘×¦×•×¨×” ×¢×©×¨×•× ×™×ª: " + (n / d).toFixed(4);
        },
      },
      {
        id: "pythagoras",
        label: "××©×¤×˜ ×¤×™×ª×’×•×¨×¡",
        fields: [
          { id: "a", label: "×¦×œ×¢ ×", type: "number" },
          { id: "b", label: "×¦×œ×¢ ×‘", type: "number" },
        ],
        calculate: (f) => {
          const c = Math.sqrt(f.a * f.a + f.b * f.b);
          return "×”×™×ª×¨ (c): " + c.toFixed(4);
        },
      },
      {
        id: "ai_math",
        label: "ğŸ¤– ×¤×ª×¨×•×Ÿ ×›×œ ×‘×¢×™×” ××ª××˜×™×ª",
        isAI: true,
        fields: [],
        calculate: () => "",
      },
    ],
  },
];

export default function SmartCalc() {
  const [activeCategory, setActiveCategory] = useState(null);
  const [activeTool, setActiveTool] = useState(null);
  const [fields, setFields] = useState({});
  const [result, setResult] = useState(null);
  const [error, setError] = useState(null);
  const [aiQuestion, setAiQuestion] = useState("");
  const [aiLoading, setAiLoading] = useState(false);

  const selectCategory = (catId) => {
    setActiveCategory(catId);
    setActiveTool(null);
    setFields({});
    setResult(null);
    setError(null);
    setAiQuestion("");
  };

  const selectTool = (tool) => {
    setActiveTool(tool);
    setFields({});
    setResult(null);
    setError(null);
    setAiQuestion("");
  };

  const handleCalc = () => {
    const parsed = {};
    for (const f of activeTool.fields) {
      const val = parseFloat(fields[f.id]);
      if (isNaN(val)) {
        setError("× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª");
        return;
      }
      parsed[f.id] = val;
    }
    try {
      const res = activeTool.calculate(parsed);
      setResult(res);
      setError(null);
    } catch (e) {
      setError("×©×’×™××” ×‘×—×™×©×•×‘");
    }
  };

  const handleAiMath = async () => {
    if (!aiQuestion.trim()) {
      setError("× × ×œ×›×ª×•×‘ ××ª ×”×‘×¢×™×” ×”××ª××˜×™×ª");
      return;
    }
    setAiLoading(true);
    setResult(null);
    setError(null);
    try {
      const response = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "anthropic-version": "2023-06-01",
          "anthropic-dangerous-direct-browser-access": "true",
        },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 1000,
          messages: [
            {
              role: "user",
              content: "××ª×” ××•×¨×” ××ª××˜×™×§×”. ×¤×ª×•×¨ ××ª ×”×‘×¢×™×” ×”×‘××” ×©×œ×‘ ××—×¨ ×©×œ×‘ ×‘×¢×‘×¨×™×ª ×¤×©×•×˜×”. ××œ ×ª×©×ª××© ×‘-Markdown ××• ×›×•×›×‘×™×•×ª. ×”×‘×¢×™×”: " + aiQuestion,
            },
          ],
        }),
      });
      const data = await response.json();
      if (data.error) {
        setError("×©×’×™××”: " + data.error.message);
      } else {
        const text = (data.content || []).map((i) => i.text || "").join("\n");
        setResult("AI:" + (text || "×œ× ×”×¦×œ×—×ª×™ ×œ×¤×ª×•×¨"));
      }
    } catch (e) {
      setError("×©×’×™××ª ×—×™×‘×•×¨. × ×¡×” ×©×•×‘.");
    }
    setAiLoading(false);
  };

  const cat = activeCategory ? categories.find((c) => c.id === activeCategory) : null;

  return (
    <div style={{
      minHeight: "100vh",
      background: "linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%)",
      fontFamily: "Arial, sans-serif",
      direction: "rtl",
      color: "#fff",
    }}>
      <div style={{
        background: "rgba(255,255,255,0.03)",
        borderBottom: "1px solid rgba(255,255,255,0.08)",
        padding: "20px 24px",
        display: "flex",
        alignItems: "center",
        gap: "14px",
      }}>
        {(activeCategory || activeTool) && (
          <button
            onClick={() => activeTool ? selectTool(null) : selectCategory(null)}
            style={{
              background: "rgba(255,255,255,0.08)",
              border: "none",
              color: "#fff",
              borderRadius: "10px",
              padding: "8px 14px",
              cursor: "pointer",
              fontSize: "15px",
            }}
          >
            ×—×–×¨×”
          </button>
        )}
        <div>
          <div style={{ fontSize: "22px", fontWeight: "700" }}>ğŸ§® ××—×©×‘×•×Ÿ ×—×›×</div>
          <div style={{ fontSize: "12px", color: "rgba(255,255,255,0.4)", marginTop: "2px" }}>
            {!activeCategory ? "×‘×—×¨ ×§×˜×’×•×¨×™×”" : !activeTool ? (cat && cat.label) : activeTool.label}
          </div>
        </div>
      </div>

      <div style={{ padding: "24px", maxWidth: "480px", margin: "0 auto" }}>

        {!activeCategory && (
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "14px" }}>
            {categories.map((c) => (
              <button
                key={c.id}
                onClick={() => selectCategory(c.id)}
                style={{
                  background: "rgba(255,255,255,0.05)",
                  border: "1px solid " + c.color + "44",
                  borderRadius: "18px",
                  padding: "24px 16px",
                  cursor: "pointer",
                  color: "#fff",
                  textAlign: "center",
                  display: "flex",
                  flexDirection: "column",
                  alignItems: "center",
                  gap: "10px",
                  transition: "all 0.2s",
                }}
                onMouseEnter={(e) => { e.currentTarget.style.background = c.color + "22"; }}
                onMouseLeave={(e) => { e.currentTarget.style.background = "rgba(255,255,255,0.05)"; }}
              >
                <span style={{ fontSize: "32px" }}>{c.icon}</span>
                <span style={{ fontSize: "15px", fontWeight: "600", color: c.color }}>{c.label}</span>
                <span style={{ fontSize: "11px", color: "rgba(255,255,255,0.35)" }}>{c.tools.length} ×›×œ×™×</span>
              </button>
            ))}
          </div>
        )}

        {activeCategory && !activeTool && cat && (
          <div style={{ display: "flex", flexDirection: "column", gap: "10px" }}>
            <div style={{ fontSize: "13px", color: "rgba(255,255,255,0.35)", marginBottom: "6px" }}>×‘×—×¨ ×›×œ×™ ×—×™×©×•×‘:</div>
            {cat.tools.map((tool) => (
              <button
                key={tool.id}
                onClick={() => selectTool(tool)}
                style={{
                  background: "rgba(255,255,255,0.05)",
                  border: "1px solid " + cat.color + "33",
                  borderRadius: "14px",
                  padding: "18px 20px",
                  cursor: "pointer",
                  color: "#fff",
                  textAlign: "right",
                  fontSize: "15px",
                  fontWeight: "500",
                  display: "flex",
                  justifyContent: "space-between",
                  alignItems: "center",
                  transition: "all 0.2s",
                }}
                onMouseEnter={(e) => { e.currentTarget.style.background = cat.color + "22"; }}
                onMouseLeave={(e) => { e.currentTarget.style.background = "rgba(255,255,255,0.05)"; }}
              >
                <span>{tool.label}</span>
                <span style={{ color: cat.color, opacity: 0.7 }}>â†</span>
              </button>
            ))}
          </div>
        )}

        {activeTool && cat && (
          <div>
            <div style={{
              background: "rgba(255,255,255,0.04)",
              border: "1px solid " + cat.color + "33",
              borderRadius: "18px",
              padding: "22px",
              display: "flex",
              flexDirection: "column",
              gap: "16px",
            }}>
              {activeTool.isAI ? (
                <div style={{ display: "flex", flexDirection: "column", gap: "14px" }}>
                  <div style={{ fontSize: "13px", color: "rgba(255,255,255,0.5)", lineHeight: "1.6" }}>
                    ×›×ª×•×‘ ×›××Ÿ ×›×œ ×‘×¢×™×” ××ª××˜×™×ª ×‘×¢×‘×¨×™×ª ××• ×‘×× ×’×œ×™×ª ğŸ§ 
                  </div>
                  <textarea
                    value={aiQuestion}
                    onChange={(e) => setAiQuestion(e.target.value)}
                    placeholder="×œ×“×•×’××”: ×¤×ª×•×¨ xÂ² - 5x + 6 = 0 | ××” ×–×” 15% ×-340?"
                    rows={4}
                    style={{
                      width: "100%",
                      background: "rgba(255,255,255,0.07)",
                      border: "1px solid rgba(255,255,255,0.12)",
                      borderRadius: "10px",
                      padding: "12px 14px",
                      color: "#fff",
                      fontSize: "15px",
                      outline: "none",
                      boxSizing: "border-box",
                      textAlign: "right",
                      direction: "rtl",
                      resize: "vertical",
                      fontFamily: "Arial, sans-serif",
                      lineHeight: "1.6",
                    }}
                  />
                  {error && (
                    <div style={{
                      background: "#ff445533",
                      border: "1px solid #ff445555",
                      borderRadius: "10px",
                      padding: "10px 14px",
                      color: "#ff8888",
                      fontSize: "13px",
                    }}>{error}</div>
                  )}
                  <button
                    onClick={handleAiMath}
                    disabled={aiLoading}
                    style={{
                      background: aiLoading ? "rgba(168,85,247,0.3)" : "linear-gradient(135deg, #A855F7, #7C3AED)",
                      border: "none",
                      borderRadius: "12px",
                      padding: "14px",
                      color: "#fff",
                      fontSize: "16px",
                      fontWeight: "700",
                      cursor: aiLoading ? "not-allowed" : "pointer",
                    }}
                  >
                    {aiLoading ? "×—×•×©×‘..." : "×¤×ª×•×¨ ×¢× AI"}
                  </button>
                </div>
              ) : (
                <div style={{ display: "flex", flexDirection: "column", gap: "14px" }}>
                  {activeTool.fields.map((f) => (
                    <div key={f.id}>
                      <label style={{
                        display: "block",
                        fontSize: "12px",
                        color: "rgba(255,255,255,0.5)",
                        marginBottom: "6px",
                      }}>{f.label}</label>
                      <input
                        type="number"
                        value={fields[f.id] || ""}
                        onChange={(e) => setFields({ ...fields, [f.id]: e.target.value })}
                        style={{
                          width: "100%",
                          background: "rgba(255,255,255,0.07)",
                          border: "1px solid rgba(255,255,255,0.12)",
                          borderRadius: "10px",
                          padding: "12px 14px",
                          color: "#fff",
                          fontSize: "16px",
                          outline: "none",
                          boxSizing: "border-box",
                          direction: "ltr",
                          textAlign: "right",
                        }}
                        placeholder="×”×›× ×¡ ××¡×¤×¨..."
                      />
                    </div>
                  ))}
                  {error && (
                    <div style={{
                      background: "#ff445533",
                      border: "1px solid #ff445555",
                      borderRadius: "10px",
                      padding: "10px 14px",
                      color: "#ff8888",
                      fontSize: "13px",
                    }}>{error}</div>
                  )}
                  <button
                    onClick={handleCalc}
                    style={{
                      background: "linear-gradient(135deg, " + cat.color + ", " + cat.color + "bb)",
                      border: "none",
                      borderRadius: "12px",
                      padding: "14px",
                      color: "#fff",
                      fontSize: "16px",
                      fontWeight: "700",
                      cursor: "pointer",
                    }}
                  >
                    ×—×©×‘
                  </button>
                </div>
              )}
            </div>

            {result && (
              <div style={{
                marginTop: "16px",
                background: "linear-gradient(135deg, " + cat.color + "22, " + cat.color + "11)",
                border: "1px solid " + cat.color + "55",
                borderRadius: "18px",
                padding: "22px",
              }}>
                <div style={{
                  fontSize: "11px",
                  color: cat.color,
                  marginBottom: "12px",
                  fontWeight: "700",
                  letterSpacing: "1px",
                }}>
                  ×ª×•×¦××”
                </div>
                {result.startsWith("AI:") ? (
                  <div style={{
                    fontSize: "15px",
                    color: "rgba(255,255,255,0.9)",
                    lineHeight: "1.9",
                    whiteSpace: "pre-wrap",
                  }}>
                    {result.slice(3)}
                  </div>
                ) : (
                  result.split("\n").map((line, i) => (
                    <div key={i} style={{
                      fontSize: i === 0 ? "20px" : "15px",
                      fontWeight: i === 0 ? "700" : "400",
                      color: i === 0 ? "#fff" : "rgba(255,255,255,0.7)",
                      marginBottom: "4px",
                      lineHeight: "1.5",
                    }}>
                      {line}
                    </div>
                  ))
                )}
              </div>
            )}
          </div>
        )}
      </div>
    </div>
  );
}